<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Agent</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="{{ url_for('static', filename='syncscroll.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="main-container">
        <div class="sidebar">
            <button id="startButton" class="mic-button">Start Voice Agent</button>
            <div id="status" class="status">Status: Inactive</div>
            <div class="audio-controls">
                <div class="device-select">
                    <label for="voiceModel">Voice Model:</label>
                    <select id="voiceModel"></select>
                </div>
            </div>
            <div class="controls">
                <label class="toggle">
                    <input type="checkbox" id="showLogs">
                    <span class="toggle-label">Show Logs</span>
                </label>
                <label class="toggle">
                    <input type="checkbox" id="darkMode" checked>
                    <span class="toggle-label">Dark Mode</span>
                </label>
            </div>
        </div>
        <div class="columns-container">
            <div id="conversation" class="timeline column">
                <h2>Conversation</h2>
                <div id="conversationMessages" class="syncscroll" name="timeline"></div>
            </div>
            <div id="logs" class="timeline column">
                <h2>Logs</h2>
                <div id="logMessages" class="syncscroll" name="timeline"></div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        const startButton = document.getElementById('startButton');
        const statusDiv = document.getElementById('status');
        const voiceModelSelect = document.getElementById('voiceModel');
        const conversationMessages = document.getElementById('conversationMessages');
        const logMessages = document.getElementById('logMessages');
        const showLogsToggle = document.getElementById('showLogs');
        const logsColumn = document.getElementById('logs');

        let isActive = false;
        let mediaRecorder;
        let audioContext;
        let audioQueue = [];
        let isPlaying = false;
        let currentVoiceModel = 'aura-2-thalia-en';

        // --- Core Audio Logic ---

        async function startAudio() {
            if (!isActive) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
                    mediaRecorder.ondataavailable = event => {
                        if (event.data.size > 0 && isActive) {
                            socket.emit('user_audio', event.data);
                        }
                    };
                    mediaRecorder.start(200); // Send audio chunks every 200ms

                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    socket.emit('start_voice_agent', { voiceModel: currentVoiceModel });
                    
                    startButton.textContent = 'Stop Voice Agent';
                    statusDiv.textContent = 'Status: Active';
                    isActive = true;
                } catch (err) {
                    console.error('Error starting audio:', err);
                    statusDiv.textContent = 'Error: Could not start audio';
                }
            } else {
                stopAudio();
            }
        }

        function stopAudio() {
            if (isActive) {
                socket.emit('stop_voice_agent');
                if (mediaRecorder) {
                    mediaRecorder.stop();
                }
                if (audioContext) {
                    audioContext.close();
                }
                audioQueue = [];
                isPlaying = false;
                startButton.textContent = 'Start Voice Agent';
                statusDiv.textContent = 'Status: Inactive';
                isActive = false;
            }
        }

        async function playNextInQueue() {
            if (isPlaying || audioQueue.length === 0) {
                return;
            }
            isPlaying = true;
            const audioData = audioQueue.shift();
            try {
                const audioBuffer = await audioContext.decodeAudioData(audioData);
                const source = audioContext.createBufferSource();
                source.buffer = audioBuffer;
                source.connect(audioContext.destination);
                source.onended = () => {
                    isPlaying = false;
                    playNextInQueue();
                };
                source.start();
            } catch (e) {
                console.error("Error playing audio:", e);
                isPlaying = false;
                playNextInQueue();
            }
        }

        // --- Socket Event Handlers ---

        socket.on('agent_audio', (audioChunk) => {
            audioQueue.push(audioChunk);
            if (!isPlaying) {
                playNextInQueue();
            }
        });

        socket.on('agent_response', (data) => {
            addMessage(data.role || 'system', data.content || JSON.stringify(data), 'conversation');
        });

        socket.on('log_message', (data) => {
            addMessage(data.level || 'info', data.message, 'log');
        });

        // --- UI and Helper Functions ---

        function addMessage(role, content, type) {
            const container = type === 'log' ? logMessages : conversationMessages;
            const messageDiv = document.createElement('div');
            messageDiv.className = `timeline-item message ${role}`;
            messageDiv.textContent = `${role}: ${content}`;
            container.appendChild(messageDiv);
            scrollToBottom(container);
        }
        
        function scrollToBottom(element) {
            element.scrollTop = element.scrollHeight;
        }

        function loadTTSModels() {
            fetch('/tts-models').then(response => response.json()).then(data => {
                if (data.error) {
                    console.error('Error loading TTS models:', data.error);
                    return;
                }
                voiceModelSelect.innerHTML = '';
                data.models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.name;
                    option.text = `${model.display_name} (${model.language})`;
                    voiceModelSelect.appendChild(option);
                });
                voiceModelSelect.value = currentVoiceModel;
            });
        }
        
        startButton.addEventListener('click', startAudio);
        voiceModelSelect.addEventListener('change', (e) => currentVoiceModel = e.target.value);
        
        document.addEventListener('DOMContentLoaded', () => {
            loadTTSModels();
        });

    </script>
</body>
</html>